!function(e,i,t,n,s,a){"use strict";var l=e.main||{};l.ARTICLE_NAME=s.get_article_name("/admin/editar"),l.MultimediaModel=t.Model.extend({defaults:{url:"",description:"",article_name:l.ARTICLE_NAME,type:"image_file",cover:!1}}),l.ImageDescriptionView=l.ArticleDescriptionView.extend({tagName:"div"}),l.MultimediaView=t.View.extend({tagName:"article",Model:l.MultimediaModel,_set_template:function(){var e=this.model.get("type");"image_file"===e?(this.templateId="#image_file_template",this.className=".image_file_container"):"image_link"===e?(this.templateId="#image_link_template",this.className=".image_link_container"):"video_link"===e?(this.templateId="#video_link_template",this.className=".video_link_container"):"undefined"==typeof e?console.error("The type of the multimedia resource is undefined."):console.error(e+" is an not valid value"),this.template=n.template(i(this.templateId).html())},initialize:function(){this.model="undefined"==typeof this.options.model?new this.Model:this.options.model,this._set_template(),this.model.set({cid:this.model.cid}),this.model.on("change:type",this._set_template,this),this.model.on("change",this.render,this),this.description_view=new l.ImageDescriptionView({Model:this.ImageDescriptionModel,model:this.model,url_handler:"/admin/save-multimedia-data"})},render:function(){var e,i=this;return this.$el.html(this.template(this.model.toJSON())).attr("id","item_"+this.model.cid).append(this.description_view.render().el),this.model.get("cover")&&this.$el.find(".cover_wrapper .article_description_done").css("display","inline-block"),e={cid:this.model.cid,id_article:l.article_data_view.model.get("id"),id_image:this.model.get("id"),type:"image_file"},this.$input_file=this.$el.find(":file"),this.uploading_deferred=this.$input_file.fileupload({dataType:"json",formData:e}),this.uploading_deferred.bind("fileuploadstart",function(){i._show_progress_bar(".image_uploading_status"),i.$el.find(".image_uploading_status .article_description_uploading").css("display","none")}).bind("fileuploadprogressall",function(e,t){i._update_progress_bar(".image_uploading_status",e,t)}).bind("fileuploadfail",function(){i._show_error_flag(".image_uploading_status")}).bind("fileuploaddone",function(e,t){i.model.set({url:t.result.url,type:t.result.type}),i._show_done_flag(".image_uploading_status")}),this.description_view.delegateEvents(),this},events:{"click .remove_image":"remove_image","mouseup .input_file":"trigger_input_file_click","click .input_link":"add_image_link","click .input_video":"add_video_link","click .cover_setter":"set_as_cover"},remove_image:function(){function e(){n.$el.remove()}var t=confirm("¿Seguro que desea borrar esta imagen? Esta acción no se puede deshacer."),n=this;t&&i.post(s.set_path("/admin/remove-multimedia"),this.model.toJSON(),e)},trigger_input_file_click:function(){this.$input_file.trigger("click"),this._hide_form_elements()},_show_progress_bar:function(e){this.$el.find(e+" .article_description_uploading").css("display","inline-block")},_update_progress_bar:function(e,i,t){var n=parseInt(t.loaded/t.total*100,10);this.$el.find(e+" .article_description_uploading").css("width",n+"%")},_show_error_flag:function(e){this.$el.find(e+" .article_description_error").css("display","inline-block"),this.$el.find(e+" .article_description_uploading").css("display","none")},_show_done_flag:function(e){this.$el.find(e+" .article_description_done").css("display","inline-block"),this.$el.find(e+" .article_description_uploading").css("display","none")},_hide_form_elements:function(){this.$el.find(".input_link_field").css("display","none"),this.$el.find(".cancel_input_link").css("display","none"),this.$el.find(".accept_link_button").css("display","none")},_hide_status_flags:function(e){this.$el.find(e+" .article_description_status").css("display","none")},add_multimedia_link:function(e){var i=this;e=e||{type:a,className:a},this._$input_link_field=this.$el.find(e.className+" .input_link_field"),this._$cancel_input_link=this.$el.find(e.className+" .cancel_input_link"),this._$accept_link_button=this.$el.find(e.className+" .accept_link_button"),this._$input_link_field.prop("readonly",!1).css({"background-color":"white",border:".1em solid lightgray",display:"inline-block"}),this._$cancel_input_link.css("display","inline-block").on("click",function(){i._$input_link_field.prop("readonly",!0).css({"background-color":"transparent",border:".1em solid transparent",display:"none"}),i._hide_form_elements()}),this._$accept_link_button.css("display","inline-block").on("click",function(){i._hide_form_elements(),i.add_multimedia_link_accept(e)})},add_multimedia_link_accept:function(t){var n,d=this,t=t||{type:a,className:a},_=d.$el.find(t.className+" .input_link_field").val();if("video_link"==t.type){var o,r=e.document.createElement("a");r.href=_,o=s.get_query_string(r.search).v,n={id:this.model.get("id"),url:_,vid:o,type:t.type}}else n={id:this.model.get("id"),url:_,type:t.type,article_name:l.ARTICLE_NAME};this._show_progress_bar(t.className+" .image_link_status"),this.$el.find(t.className+" .image_link_status .article_description_uploading").css("display","inline-block"),this._deferred_image_link=i.post(s.set_path("/admin/save-multimedia-link"),n),this._deferred_image_link.done(function(){var e=n.type;"video_link"==e?d.model.set({type:e,vid:n.vid}):d.model.set({url:n.url,type:e}),d._show_done_flag(t.className+" .image_link_status")}).fail(function(){d._show_error_flag(t.className+" .image_link_status")})},add_image_link:function(){var e=".image_wrapper";this._hide_status_flags(e),this._hide_form_elements(),this.add_multimedia_link({type:"image_link",className:e})},add_video_link:function(){var e=".video_wrapper";this._hide_status_flags(e),this._hide_form_elements(),this.add_multimedia_link({type:"video_link",className:e})},set_as_cover:function(){var e=this;this._cover_data={id:this.model.get("id"),article_name:this.model.get("article_name"),cover:!0},this._set_cover_deferred=i.post(s.set_path("/admin/set-as-cover"),this._cover_data),this._set_cover_deferred.done(function(){i(".cover_wrapper .article_description_done").css("display","none"),e._show_done_flag(".cover_wrapper .image_link_status")}).fail(function(){e._show_error_flag(".cover_wrapper .image_link_status")})}}),l.ImageCollection=t.Collection.extend({url:s.set_path("/admin/get-article-data"),model:l.MultimediaModel}),l.ImageCollectionView=t.View.extend({tagName:"article",id:"new_multimedia_container",template:i("#new_multimedia_template").html(),defaults:{ImageModel:l.MultimediaModel,ImageView:l.MultimediaView,ImageCollection:l.ImageCollection,container:"#content"},initialize:function(){var e=this;this.options=i.extend({},this.defaults,this.options),this.shard_cycle=new s.Cycle(["",1,2,3,4]),this.settings_deferred=i.getJSON(s.set_path("applications/image_settings.json")),this.settings_deferred.done(function(t){e.settings=i.extend({},t.defaults,t.edit_image)}),this.collection=new this.options.ImageCollection,this.$container=i(this.options.container),this.$el.appendTo(this.$container),l.article_data_view.fetch_deferred.done(function(){e.render()}),this.collection.on("reset",this.add_shard_values,this).on("reset",function(){l.article_data_view.fetch_deferred.done(function(){e.settings_deferred.done(function(){e.render_all()})})},this).fetch({data:{edit_url:s.get_article_name(),data_group:"multimedia"}})},render:function(){this.$el.detach().appendTo(this.$container),this.$el.html(this.template),this.$add_multimedia_file=this.$el.find("#add_multimedia_file");var e=new s.Breakpoints(this.settings);return this.$add_multimedia_file.css("width",e.width),this},render_one:function(e){var i,t=new s.Breakpoints(this.settings);e.set({quality:t.settings.quality,width:t.width,height:Math.round(t.width/this.settings.ratio)}),i=new this.options.ImageView({model:e,type:this.options.type}),this.$container.append(i.render().el).append(" "),this.fix_sizes(t),i.description_view.fix_textarea_size()},render_all:function(){this.$el.detach(),this.collection.each(this.render_one,this),this.$el.appendTo(this.$container)},events:{"click #add_multimedia_file":"add_multimedia_file"},add_multimedia_file:function(){var e=this;this.$el.detach(),this._breakpoints=new s.Breakpoints(this.settings),this._multimedia_model=new this.options.ImageModel,this._multimedia_model.set({shard:this.shard_cycle.__next__(),cid:this._multimedia_model.cid,quality:this._breakpoints.settings.quality,width:this._breakpoints.width,height:Math.round(this._breakpoints.width/this.settings.ratio),type:"image_link"}),this._deferred_multimedia_data=i.post(s.set_path("/admin/save-multimedia-data"),e._multimedia_model.toJSON(),function(i){e._multimedia_model.set(i)}),this._image_view=new this.options.ImageView({model:this._multimedia_model}),this._$image_container=i(this._image_view.render(this._multimedia_model).el),this._$image_container.appendTo(this.$container),this._$input_file=this._$image_container.find('[name="input_image_'+this._multimedia_model.cid+'"]'),this._$input_file.appendTo(this._$image_container),this.$container.append(" "),this.$el.appendTo(this.$container)},add_shard_values:function(){var e=this;this.collection.each(function(i){i.set({shard:e.shard_cycle.__next__()})},this)},fix_sizes:function(e){var t=e.width+"px";i("article > figure > img").css({"max-width":t}),i(".column").css({"max-width":t})}}),"undefined"==typeof jasmine&&i(function(){l.multimedia_collection_view=new l.ImageCollectionView}),e.main=l}(this,jQuery,Backbone,_,helpers);